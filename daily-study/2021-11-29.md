# Event Source

**EventSource** æ˜¯æœåŠ¡å™¨æ¨é€çš„ä¸€ä¸ªç½‘ç»œäº‹ä»¶æ¥å£ã€‚ä¸€ä¸ª EventSource å®ä¾‹ä¼šå¯¹ HTTP æœåŠ¡å¼€å¯ä¸€ä¸ªæŒä¹…åŒ–çš„è¿æ¥ï¼Œä»¥ text/event-stream æ ¼å¼å‘é€äº‹ä»¶, ä¼šä¸€ç›´ä¿æŒå¼€å¯ç›´åˆ°è¢«è¦æ±‚å…³é—­ã€‚

ç›¸å…³æ–‡æ¡£å¯ä»¥å‚è€ƒ [EventSource](https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource)

ç®€å•ä½¿ç”¨ EventSource

```ts
var evtSource = new EventSource('sse.php')
var eventList = document.querySelector('ul')

evtSource.onmessage = function (e) {
  var newElement = document.createElement('li')

  newElement.textContent = 'message: ' + e.data
  eventList.appendChild(newElement)
}
```

é¦–å…ˆåˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œè°ƒç”¨å®ä¾‹çš„æ–¹æ³•ç›‘å¬æ¶ˆæ¯ã€‚

ä¸‹é¢ä½¿ç”¨ EventSource ç»“åˆ React å’Œ NodeJs å®ç°ä¸€ä¸ªç®€å•çš„ Server-Sent Eventã€‚

## æ„å»º NodeJs åº”ç”¨

åˆå§‹åŒ– NodeJs é¡¹ç›®

```shell
mkdir -p sse/backend
cd sse/backend
yarn init -y
```

å®‰è£…å¹¶åˆå§‹åŒ– ts

```shell
yarn add -D typescript ts-node
yarn tsc --init
```

å®‰è£… express å’Œ cors

```shell
yarn add express cors
yarn add -D @types/express @types/cors
```

åˆ›å»º `src/app.ts`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```ts
import express, { Request, Response } from 'express'
import cors from 'cors'

const donation = {
  user: 0,
  amount: 0
}

const app = express()

app.use(express.json())
app.use(cors())

app.post('/donate', (req, res) => {
  const amount = req.body.amount || 0

  if (amount > 0) {
    donation.amount += amount
    donation.user += 1
  }

  return res.json({ message: 'Thank you ğŸ™' })
})

app.listen(4650, () => {
  console.log(`Application started on URL ğŸ‰`)
})
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª webserver ä»¥åŠä¸€ä¸ª /donate çš„è·¯ç”±ã€‚ä½¿ç”¨ä»¥ä¸‹ä»£ç å¯åŠ¨åº”ç”¨ï¼š

```shell
yarn ts-node src/app.ts
```

### å®ç° SSE

æˆ‘ä»¬æƒ³è¦æ¯ 2 ç§’æ›´æ–°å®¢æˆ·ç«¯çš„ donation ä¿¡æ¯ï¼Œå¢åŠ ä»¥ä¸‹ä»£ç åˆ° `src/app.ts` ä¸­ï¼š

```ts
const SEND_INTERVAL = 2000

const writeEvent = (res: Response, sseId: string, data: string) => {
  res.write(`id: ${sseId}\n`)
  res.write(`data: ${data}\n\n`)
}

const sendEvent = (_req: Request, res: Response) => {
  res.writeHead(200, {
    'Cache-Control': 'no-cache',
    Connection: 'keep-alive',
    'Content-Type': 'text/event-stream'
  })

  const sseId = new Date().toDateString()

  setInterval(() => {
    writeEvent(res, sseId, JSON.stringify(donation))
  }, SEND_INTERVAL)

  writeEvent(res, sseId, JSON.stringify(donation))
}

app.get('/dashboard', (req: Request, res: Response) => {
  if (req.headers.accept === 'text/event-stream') {
    sendEvent(req, res)
  } else {
    res.json({ message: 'Ok' })
  }
})
```

å¯åŠ¨åº”ç”¨ç¡®ä¿å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä½†æ˜¯ä¸ºäº†æµ‹è¯• SSEï¼Œè¿˜éœ€è¦åˆ›å»ºå¯¹åº”çš„å®¢æˆ·ç«¯ã€‚

## æ„å»ºå‰ç«¯åº”ç”¨

ä½¿ç”¨ Vite æ¥å¿«é€Ÿåˆ›å»º React åº”ç”¨

```shell
yarn create vite frontend --template react-ts
cd frontend
yarn dev
```

ä½¿ç”¨ä»¥ä¸‹ä»£ç æ›¿æ¢ `App.tsx` ä¸­çš„å†…å®¹ï¼š

```tsx
import React, { useEffect, useState } from 'react'

type Donation = {
  user: number
  amount: number
}

const App = () => {
  const [donation, setDonation] = useState<Donation>({ user: 0, amount: 0 })

  useEffect(() => {
    const source = new EventSource(`http://localhost:4650/dashboard`)

    source.addEventListener('open', () => {
      console.log('SSE opened!')
    })

    source.addEventListener('message', e => {
      console.log(e.data)
      const data: Donation = JSON.parse(e.data)

      setDonation(data)
    })

    source.addEventListener('error', e => {
      console.error('Error: ', e)
    })

    return () => {
      source.close()
    }
  }, [])

  return (
    <div>
      <h1>Donation status</h1>
      <hr />
      <h3>Total amount: {donation.amount}</h3>
      <h3>Total user: {donation.user}</h3>
    </div>
  )
}

export default App
```

å¯åŠ¨åç«¯åº”ç”¨ï¼Œç„¶åé‡æ–°åˆ·æ–°å‰ç«¯åº”ç”¨ï¼Œ çœ‹ä¸‹ç»“æœã€‚

å¯ä»¥ä»æ§åˆ¶å°çœ‹å‡ºï¼Œå·²ç»ä¸æœåŠ¡ç«¯å»ºç«‹äº†è¿æ¥ã€‚

![01](./img-20111129/01.png)

å‘é€ post è¯·æ±‚å¯ä»¥çœ‹è¯·æ±‚æ•ˆæœ:

```shell
curl -H "Content-Type: application/json" -X POST -d '{"amount": 10}' http://localhost:4650/donate
```

![02](./img-20111129/02.png)

å®¢æˆ·ç«¯ä¹Ÿéšä¹‹å‘ç”Ÿäº†å˜åŒ–

![03](./img-20111129/03.png)

ä¿®æ”¹å‚æ•°ç»§ç»­å°è¯•ä¸€æ¬¡

![04](./img-20111129/04.png)
![05](./img-20111129/05.png)

That is it!!!
